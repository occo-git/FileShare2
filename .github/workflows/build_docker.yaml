name: Build and Push Docker Image to AWS

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      # DOCKER_HUB_USERNAME:
      #   required: true
      # DOCKER_HUB_TOKEN:
      #   required: true

jobs:
  build:
    runs-on: windows-latest

    #env:
    #   IMAGE_TAG: ${{ github.sha }}

    permissions:
      id-token: write
      contents: read
    
    steps:
    
    # get code from repo
    - name: Checkout code
      uses: actions/checkout@v4
                          
    - name: Read config values
      id: read_config
      shell: powershell
      run: |
        $config = Get-Content -Raw -Path "$env:GITHUB_WORKSPACE\FileShare2\build\build_config.json" | ConvertFrom-Json
        "AWS_ACCOUNT_ID=$($config.build_docker.AWS_ACCOUNT_ID)" | Add-Content -Path $env:GITHUB_ENV
        "AWS_REGION=$($config.build_docker.AWS_REGION)" | Add-Content -Path $env:GITHUB_ENV
        "IMAGE_TAG=$($config.build_docker.IMAGE_TAG)" | Add-Content -Path $env:GITHUB_ENV
        
    - name: Set up IMAGE_REPO variable
      shell: powershell
      run: |
        "IMAGE_REPO=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/file_share/file_share_repo_latest" | Add-Content -Path $env:GITHUB_ENV

    - name: Output environment variables
      run: |
        echo "AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }}"
        echo "AWS_REGION=${{ env.AWS_REGION }}"
        echo "IMAGE_REPO=${{ env.IMAGE_REPO }}"
        echo "IMAGE_TAG=${{ env.IMAGE_TAG }}"

    - name: Set up AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to ECR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        username: ${{ secrets.AWS_ACCESS_KEY_ID }}
        password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    # Build Docker image
    - name: Build Docker image
      run: docker build -t ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} -f FileShare2/Dockerfile FileShare2/ 

    # Push Docker image
    - name: Push Docker image
      run: docker push ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}



    # - name: Log in to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_HUB_USERNAME }}
    #     password: ${{ secrets.DOCKER_HUB_TOKEN }}

    # # Build Docker image
    # - name: Build Docker image
    #   run: docker build -t file_share/file_share_repo:latest -f FileShare2/Dockerfile FileShare2/ 

    # # Push Docker image
    # - name: Push Docker image
    #   run: |
    #     docker push file_share/file_share_repo:latest
    #     docker tag file_share/file_share_repo:latest ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/file_share/file_share_repo_latest:latest${{ github.sha }}
    #     docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/file_share/file_share_repo_latest:latest${{ github.sha }}